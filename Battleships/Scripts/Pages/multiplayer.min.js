function getUserStats(){$.ajax({url:"../../Content/Ajax/statisticsAjax.php",data:{action:"multiplayerStats"},type:"post",success:function(e){e=JSON.parse(e),userStats=e[0]},error:function(){}})}function changePage(e){$(".subPage:not("+e+")").fadeOut(200).promise().done(function(){"#subPagePlayGame"==e?$("#pageMultiplayer").addClass("birdsEyeView"):$("#pageMultiplayer").removeClass("birdsEyeView"),$(e).fadeIn(500)})}function createRoom(){$(createGameCont).fadeIn(500),$(createRoomButtonConf).unbind("click").one("click",function(){showWaiting("Creating a game, please wait...");var e=(parseInt(userStats.gamesPlayed)/(parseInt(userStats.gamesPlayed)+parseInt(userStats.incompleteGames))*100).toFixed(2);0==userStats.gamesPlayed&&(e=100);var t=$("[name=size]:checked").val(),o=convertBoardSizeStrToInt(t);boardSize=o,boardSizeStr=t,data={name:session.id,boardSize:o,highScore:userStats.highScore,completionRate:e},socket.emit("createGame",data),$(createGameCont).fadeOut(500)}),$(createRoomButtonCancel).off("click").one("click",function(){$(createGameCont).fadeOut(500),$(createRoomButton).off("click").one("click",function(){createRoom()})})}function joinGame(e,t){host=!1,boardSize=t,boardSizeStr=convertBoardSizeIntToStr(t),$(".joinGame").off("click"),socket.emit("joinGame",e),showWaiting(!0,"Connecting you to the game, good luck!")}function initGame(){resetMultiplayerBoard(),incrementIncompleteGames(),shipsToPlace=new Array,populateShips(),initPlaceShips(),game=new Game(boardSize),playerBoardClass=game.getPlayerBoard(),opponentBoardClass=game.getComputerBoard()}function populateShips(){var e="";for(i=0;i<shipDetails.length;i++)shipsToPlace.push(new Ship(shipDetails[i].name,shipDetails[i].size)),e+="<li class='"+shipDetails[i].name+"'></li>";$(page+" .boardExtrasContainer ul.remainingShips").html(e)}function shipsPlaced(){removeHovers(),$(window).unbind("keydown"),setTimeout(function(){$(startGameButton).fadeIn(500)},200),$(startGameButton).unbind("click").one("click",function(){$(startGameButton).fadeOut(500),$(resetBoardButton).fadeOut(500).unbind("click"),$(undoLastShipButton).fadeOut(500).unbind("click"),showWaiting(!0,"You're ready to play!<br/><br/>Please wait for your opponent to place their ships");for(var e=playerBoardClass.getShipsPlaced(),t=new Array,o=0;o<e.length;o++)t.push(e[o].toObject());host?socket.emit("hostReady",t):socket.emit("playerReady",t)})}function playerMove(){$(page+" "+opponentBoard+" td").bind("mouseenter",function(){var e=$(this),t=boardFireHover(e);t?e.unbind("click").one("click",function(){fireAtPlayer(e)}):(cleanupHoverClasses(),removeClicks()),e.bind("mouseleave",function(){cleanupHoverClasses(),removeClicks()})})}function fireAtPlayer(e){if(e){removeHovers(),removeClicks(),cleanupHoverClasses();var t=e.index(),o=e.closest("tr"),a=o.index();totalShots++,socket.emit("fire",{x:t,y:a}),showWaiting(!0,"Firing at opponent's board!",.4)}}function boardFireAtSelf(e,t){var o=playerBoardClass.fire(e,t);o&&totalHitsReceived++;var a=playerBoardClass.getCoordinateAt(e,t),n=a.toObject();$(page+" "+playerBoard+" tr:eq("+t+") > td:eq("+e+")").addClass("hit");var r=a.getShip(e,t);return r&&r.isDestroyed()&&$("#playerContainer .boardExtrasContainer ul.remainingShips li."+r.getName()).addClass("destroyed"),n}function boardFireAtOpponent(e,t){var o=opponentBoardClass.fire(e,t);if($(page+" "+opponentBoard+" tr:eq("+t+") > td:eq("+e+")").addClass("hit"),o){totalHits++,$(page+" "+opponentBoard+" tr:eq("+t+") > td:eq("+e+")").addClass("containsShip");var a=opponentBoardClass.getCoordinateAt(e,t),n=a.getShip();n&&n.isDestroyed()&&(setShipAttributesOnBoard(opponentBoard,n),$("#opponentContainer .boardExtrasContainer ul.remainingShips li."+n.getName()).addClass("destroyed"))}}function updatePerks(){var e=game.getPlayerPerksAvailable(),t="";$.each(e,function(e,o){var a=e.split("_");a=a.join(" "),t+="<li>",t+="<button ",t+="class='button perk' ",t+="data-perk='"+e+"' ",o.usesLeft<=0&&(t+="disabled ",o.usesLeft=0),t+=">",t+=a,t+=" "+o.usesLeft,t+="</button>",t+="</li>"}),$("#playerContainer .perks").html(t),$("#playerContainer .perk:not(:disabled)").off("click").one("click",function(){var e=$(this),t=$(e).data("perk");runPlayerPerk(t)})}function disablePerks(){$("#playerContainer .perk").attr("disabled","disabled")}function runPlayerPerk(e){switch(disablePerks(),e){case"Sonar":initSonarPerk();break;case"Bounce_Bomb":initBounceBombPerk();break;case"Mortar":initMortarPerk()}}function endPlayerPerk(e,t){game.updatePlayerPerks(t);updatePerks(),e?(socket.emit("fire","skip"),showWaiting(!0,"Your opponent is making their move.<br/><br/>Get ready to make yours!",.4)):playerMove()}function sonarAction(e,t){var o={perk:"Sonar",x:e,y:t};socket.emit("usePerk",o)}function runSonarPerk(e,t){var o=new Sonar(playerBoardClass),a=o.action(e,t),n={perk:"Sonar",x:a?a.getX():null,y:a?a.getY():null};a&&$(page+" "+playerBoard+" tr:eq("+a.getY()+") > td:eq("+a.getX()+")").addClass("sonarShipLocation"),socket.emit("runPerkResponse",n)}function responseSonarPerk(e,t){null!=e&&null!=t?$(page+" "+opponentBoard+" tr:eq("+t+") > td:eq("+e+")").addClass("sonarShipLocation"):showMessageTimeout("No moves found! Better luck next time...",3e3),endPlayerPerk(!0,"Sonar")}function bounceBombAction(e,t,o){var a={perk:"Bounce_Bomb",x:e,y:t,orientation:o};socket.emit("usePerk",a)}function runBounceBombPerk(e,t,o){var a=new BouncingBomb(opponentBoardClass),n=a.action(e,t,o);boardFireAtSelf(e,t),2==n&&(1==o?boardFireAtSelf(e,t-1):boardFireAtSelf(e+1,t));var r={perk:"Bounce_Bomb",num:n,orientation:o,x:e,y:t};socket.emit("runPerkResponse",r)}function responseBounceBombPerk(e){boardFireAtOpponent(e.x,e.y),2==e.num&&(1==e.orientation?boardFireAtOpponent(e.x,e.y-1):boardFireAtOpponent(e.x+1,e.y)),endPlayerPerk(!0,"Bounce_Bomb")}function mortarAction(e,t){var o={perk:"Mortar",x:e,y:t};socket.emit("usePerk",o)}function runMortarPerk(e){for(var t=new Mortar(playerBoardClass),o=t.action(e.x,e.y),a=new Array,n=0;n<o.length;n++)a.push(o[n].toObject()),boardFireAtSelf(o[n].getX(),o[n].getY());var e={perk:"Mortar",cells:a};socket.emit("runPerkResponse",e)}function responseMortarPerk(e){for(var t=e.cells,o=0;o<t.length;o++)boardFireAtOpponent(t[o].x,t[o].y);endPlayerPerk(!0,"Mortar")}function showRemainingShips(){for(var e=opponentBoardClass.getFloatingShips(),t=0;t<e.length;t++)setShipAttributesOnBoard(opponentBoard,e[t])}function resetMultiplayerBoard(){$(".board").attr("data-size",boardSizeStr);for(var e="<tbody>",t=0;t<boardSize;t++){e+="<tr>";for(var o=0;o<boardSize;o++)e+="<td><i class='hit'></i></td>";e+="</tr>"}e+="</tbody>",$(".board").html(e),$(boardExtras).hide(),$(createRoomButton).off("click").one("click",function(){createRoom()})}function statisticsAjax(e){var t=new Date,o=(t.getTime()-startTime.getTime())/1e3,a=0;switch(boardSize){case 15:a=100;break;case 20:a=200}var n=100,r=5,i=1,s=5,c=0,l=1,d=totalShots-totalHits,u=0;if(o<300)var u=(300-o)*l;e&&(c=100);var p=totalHitsReceived*r,m=d*i,f=totalHits*s,k=totalHits/totalShots*100,h=n-p-m+f+u+c+a;showScore(h,p,m,f,u,c,a),$.ajax({url:"../../Content/Ajax/multiplayerAjax.php",data:{action:"recordShots",totalHits:totalHits,totalHitsReceived:totalHitsReceived,totalShots:totalShots,playingTime:o,gameScore:h},type:"post"}),$.ajax({url:"../../Content/Ajax/medalAjax.php",data:{action:"checkMedalConditions",difficulty:"multiplayer",winner:"player",boardSize:boardSize,accuracy:k,numberOfHits:totalHitsReceived},type:"post"}),window.onbeforeunload=null}function incrementIncompleteGames(){$.ajax({url:"../../Content/Ajax/multiplayerAjax.php",data:{action:"incrementIncompleteGames"},type:"post"})}function decrementIncompleteGames(){$.ajax({url:"../../Content/Ajax/multiplayerAjax.php",data:{action:"decrementIncompleteGames"},type:"post"})}function winAjax(){$.ajax({url:"../../Content/Ajax/multiplayerAjax.php",data:{action:"recordWin"},type:"post"})}function showScore(e,t,o,a,n,r,i){won=0!=r,$(scoreModal+" span").hide(),$(scoreModalTitle).html(won?"You Won!":"You Lost!"),$(scoreModalOverlay).fadeIn(200),$(scoreModal).fadeIn(500),$("#baseScore span").fadeIn(500),setTimeout(function(){var e=t<0?"":"- ";$(scoreModal+" #hitsReceived span").html(e+t+"pts").fadeIn(500)},500),setTimeout(function(){var e=o<0?"":"- ";$(scoreModal+" #shotsMissed span").html(e+o+"pts").fadeIn(500)},1e3),setTimeout(function(){var e=a<0?"":"+ ";$(scoreModal+" #shotsHit span").html(e+a+"pts").fadeIn(500)},1500),setTimeout(function(){var e=n.toFixed(2)<0?"":"+ ";$(scoreModal+" #timeBonus span").html(e+n.toFixed(2)+"pts").fadeIn(500)},2e3),setTimeout(function(){var e=r<0?"":"+ ";$(scoreModal+" #winBonus span").html(e+r+"pts").fadeIn(500)},2500),setTimeout(function(){var e=i<0?"":"+ ";$(scoreModal+" #boardSizeBonus span").html(e+i+"pts").fadeIn(500)},3e3),setTimeout(function(){$(scoreModal+" #total span").html(e.toFixed(2)+"pts").fadeIn(500)},3500),$("#closeModal").off("click").one("click",function(){$(scoreModalOverlay).fadeOut(200),$(scoreModal).fadeOut(500)}),$("#scoreBackToMultiplayer").off("click").one("click",function(){$(createRoomButton).off("click").one("click",function(){createRoom()}),changePage("#subPageRoom"),resetMultiplayerBoard(),$(backToMultiplayerButton).hide(),$(scoreModalOverlay).fadeOut(200),$(scoreModal).fadeOut(500)})}var socket=io.connect("https://battleships-preprod.tk:3000",{secure:!0}),game,host=!1,playerBoardClass,opponentBoardClass,boardSizeStr,boardSize,userStats=null,page="#subPagePlayGame",playerBoard="#playerBoard",opponentBoard="#opponentBoard",createRoomButton="#createGame",createRoomButtonConf="#createRoomButtonConf",createRoomButtonCancel="#createRoomButtonCancel",createGameCont="#createGameCont",cancelGameButton="#cancelGame",backToMultiplayerButton="#backToMultiplayer",boardExtras=".boardExtras",startGameButton="#playerReady",rotateShipButton="#rotateShip",undoLastShipButton="#undoLastShip",resetBoardButton="#resetBoard",availableRooms="#availableRooms",scoreModalOverlay="#scoreModalOverlay",scoreModal="#scoreModal",scoreModalTitle=scoreModal+" #resultTitle",totalShots,totalHits,totalHitsReceived,startTime,shipDetails=[{name:"Destroyer",size:2},{name:"Submarine",size:3},{name:"Cruiser",size:3},{name:"BattleShip",size:4},{name:"Carrier",size:5}],shipsToPlace=new Array;$(document).ready(function(){showWaiting(!0,"Connecting you, Please wait..."),getUserStats(),socket.emit("join",session.id);var e=0,t=setInterval(function(){socket.emit("join",session.id)},5e3);socket.on("joinServerRepsonse",function(o){o?(showWaiting(!1),clearInterval(t)):(e++,showWaiting(!0,"Failed to join server! Trying again in 5 seconds...<br/><br/> Times Failed: "+e))}),$(createRoomButton).off("click").one("click",function(){createRoom()})}),socket.on("playersOnline",function(e){$("#playersOnline").html("Online ("+e+" Worldwide)")}),socket.on("opponentName",function(e){$("#opponentName").html("Opponent: "+e)}),socket.on("gameList",function(e){var t=!1,o="";for(var a in e)e.hasOwnProperty(a)?2!=e[a].players.length&&"available"==e[a].status&&(t=!0,o+="<tr>",o+="<td>",o+=e[a].name,o+="</td>",o+="<td>",o+=e[a].boardSize+" x "+e[a].boardSize,o+="</td>",o+="<td>",o+=e[a].hostHighScore,o+="</td>",o+="<td>",o+=e[a].hostCompletionRate+"%",o+="</td>",e[a].name!=session.id&&(o+="<td>",o+="<button ",o+="class='joinGame' ",o+="data-game='"+e[a].id+"'",o+="data-size='"+e[a].boardSize+"'",o+=">",o+="Battle",o+="</button>",o+="</td>"),o+="</tr>"):o+="<tr class='noGamesFound'><td colspan='4'>No games found!</td></tr>";t||(o="<tr class='noGamesFound'><td colspan='4'>No games found!</td></tr>"),$(availableRooms+" tbody").html(o),$(".joinGame").off("click").on("click",function(){var e=$(this).data("game"),t=$(this).data("size");joinGame(e,t)})}),socket.on("createGameResponse",function(e){if(e){host=!0;var t="You have created a game!<br/>Please wait for someone to join, and good luck!<br/><br/>";t+="<button id='cancelGame'>Cancel</button>",showWaiting(!0,t),$(document).off("click").one("click",cancelGameButton,function(){$(cancelGameButton).off("click"),socket.emit("leaveGame"),showWaiting(!1),$(createRoomButton).off("click").one("click",function(){createRoom()})})}else showMessageTimeout("Failed to Create Game! Please try again...",2e3),$(createRoomButton).off("click").one("click",function(){createRoom()})}),socket.on("joinGameResponse",function(e){showWaiting(!1),e?(changePage("#subPagePlayGame"),$(backToMultiplayerButton).hide(),initGame()):showMessageTimeout("We couldn't join you to the game! Please try again...")}),socket.on("gameReady",function(e){for(var t=0;t<e.length;t++){var o=e[t],a=new Ship(o.name,o.size);1!=o.orientation&&a.changeOrientation();var n=o.coordinates;opponentBoardClass.placeShip(a,n[0].x,n[0].y)}showWaiting(!0,"Your opponent is making their move.<br/><br/>Get ready to make yours!"),$(boardExtras).fadeIn(500),updatePerks(),totalShots=0,totalHits=0,totalHitsReceived=0,startTime=new Date}),socket.on("playerToStart",function(e){showWaiting(!1),e&&playerMove()}),socket.on("recordHit",function(e){if("skip"==e)playerMove(),showWaiting(!1);else if(e){var t=e.x,o=e.y,a=boardFireAtSelf(t,o);socket.emit("recordHitResponse",{coordinate:a}),playerBoardClass.isViable()?playerMove():socket.emit("lostGame"),showWaiting(!1)}}),socket.on("fireResponse",function(e){showWaiting(!1);var t=e.coordinate;boardFireAtOpponent(t.x,t.y),showWaiting(!0,"Your opponent is making their move.<br/><br/>Get ready to make yours!",.4)}),socket.on("runPerk",function(e){switch(e.perk){case"Sonar":runSonarPerk(e.x,e.y);break;case"Bounce_Bomb":runBounceBombPerk(e.x,e.y,e.orientation);break;case"Mortar":runMortarPerk(e)}}),socket.on("usePerkResponse",function(e){switch(e.perk){case"Sonar":responseSonarPerk(e.x,e.y);break;case"Bounce_Bomb":responseBounceBombPerk(e);break;case"Mortar":responseMortarPerk(e)}}),socket.on("lostGameResponse",function(e){showWaiting(!1),e?(showRemainingShips(),statisticsAjax(!1)):(statisticsAjax(!0),winAjax()),$(backToMultiplayerButton).fadeIn(500,function(){$(backToMultiplayerButton).off("click").one("click",function(){$(backToMultiplayerButton).fadeOut(500),$(createRoomButton).off("click").one("click",function(){createRoom()}),changePage("#subPageRoom"),resetMultiplayerBoard()})})}),socket.on("playerLeftResponse",function(e){e&&(showWaiting(!1),changePage("#subPageRoom"),decrementIncompleteGames(),resetMultiplayerBoard(),showMessageTimeout("Your opponent has left the game! Taking you back to the menu",3e3))});